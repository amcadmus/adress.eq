% \documentclass[aip,jcp,preprint,unsortedaddress,a4paper,onecolum]{revtex4-1}
\documentclass[aip,jcp,a4paper,reprint,onecolumn]{revtex4-1}
% \documentclass[aps,pre,twocolumn]{revtex4-1}
% \documentclass[aps,jcp,groupedaddress,twocolumn,unsortedaddress]{revtex4}

\usepackage[fleqn]{amsmath}
\usepackage{amssymb}
\usepackage[dvips]{graphicx}
\usepackage{color}
\usepackage{tabularx}
\usepackage{algorithm}
\usepackage{algorithmic}

\makeatletter
\makeatother

\newcommand{\recheck}[1]{{\color{red} #1}}
\newcommand{\redc}[1]{{\color{red} #1}}
\newcommand{\bluec}[1]{{\color{blue} #1}}
\newcommand{\vect}[1]{\textbf{\textit{#1}}}
\newcommand{\dd}[1]{\textsf{#1}}

\newcommand{\AT}{{\textrm{{AT}}}}
\newcommand{\EX}{{\textrm{EX}}}
\newcommand{\CG}{{\textrm{CG}}}
\newcommand{\HY}{{\Delta}}
\newcommand{\rdf}{{\textrm{rdf}}}



\begin{document}

\title{The reliability of AdResS in sampling a Grand Canonical distribution}
\author{Han Wang}
\affiliation{Institute for Mathematics, Freie Universit\"at Berlin, Germany}
\author{Carsten Hartmann}
\affiliation{Institute for Mathematics, Freie Universit\"at Berlin, Germany}
\author{Christof Sch\"utte}
\affiliation{Institute for Mathematics, Freie Universit\"at Berlin, Germany}
\author{Luigi Delle Site}
\email{luigi.dellesite@fu-berlin.de}
\affiliation{Institute for Mathematics, Freie Universit\"at Berlin, Germany}

\begin{abstract}
\end{abstract}

\maketitle

\section{Introduction}
The Adaptive Resolution Simulation (AdResS) scheme~\cite{jcp,pre} is a
method that in a concurrent fashion simulates a molecular system treated with different
resolutions in different regions of space.  The word ``resolution''
here refers to the amount of details included in a molecular model: usually, the higher the
resolution, the more precise the model is , and the higher the corresponding computational cost.  The advantage is obvious, it
keeps track of both: the local fine-grained processes in the
high-resolution regions and the large scale behavior, requiring a less demanding computational effort compared to the system that, as a
whole, would be described by the high-resolution model. The key feature of
AdResS is that it allows an on-the-fly changing of resolution when a
molecule travels from a high-resolution region to a low-resolution
region and vice versa. Moreover, recent research~\cite{prlgc, rdfcorr}
numerically demonstrates that different resolutions reach a
thermodynamic equilibrium as if the whole system is equilibriated
under the high-resolution description. Therefore, the a region with a
certain resolution exchanges molecules with the rest of the system in
a Grand Canonical fashion. This work, from the theoretical point of
view, studies the conditions, under which the AdResS is an effective
Grand Canonical simulation, and tries to shed light on the accuracy of
the sampling.

\section{A brief description of the AdResS scheme}

In this work, the higher resolution refers to the atomistic
description (AT) of a molecule, while the lower resolution refers to
the its corresponding coarse-grained (CG) modeling.  We assume that the dynamics of the
system is subjected to the Langevin equation, which is the thermostat
usually used in the AdResS simulations:
\begin{align}
  \dd d\vect r_i &= \vect v_i\dd dt\\
  m_i\dd d\vect v_i &= (-m_i\xi_i\vect v_i + \vect F_i)\,\dd dt + \sqrt{2\sigma_i}\;\dd d\vect W_t
\end{align}
where $\dd d\vect W_t$ is the standard Wiener process. We denote the
phase space variable $\vect x = \{\vect r_i, \vect v_i\}$; $\vect r_i,
\vect v_i$ are the degrees of freedoms (DOFs) of the system.  If the
system is conservative, namely $\vect F_i = -\nabla_{\vect r_i}U$,
then one obtains the equilibrium density distribution $p(\vect
x)\propto e^{-\beta\mathcal H(\vect x)}$. In the AdResS scheme,
different resolutions in the system are described by a weighting
function of position $w(\vect r)$. Usually the higher resolutions is
denoted by $w = 1$, while the lower resolution is denoted by $w = 0$.
Between the higher and lower resolutions, a hybrid region allows a 
molecule to have both (interpolated) resolutions. The weighting function changes smoothly
from 0 to 1 and one possible weighting function is:
\begin{align}\label{eqn:new-w}
  w(\vect r) =
  \left\{
    \begin{array}{lcl}
      1 &\quad& \chi < 0\\
      1  && 0 < \chi < r_c\\
      \cos^2\big[\frac{\pi}{2(d_{\HY} - r_c)} (\chi - d_{\textrm{ex}} - r_c)\big] && r_c < \chi < d_{\HY} \\
      0 &&  d_{\HY}  < \chi.
    \end{array}
  \right.
\end{align}
Where $\chi$ is the distance to the boundary of the higher resolution
region, $\chi < 0$ means that the molecule is in the higher resolution
region, $d_{\HY}$ is the thickness of the hybrid region, $r_c$ is the
cut-off radius.  The intermolecular force is modeled by the following
interpolation formula \cite{rdfcorr}:
\begin{align}
  \vect F_{\alpha\beta} =
  w_\alpha w_\beta\vect F^{\AT}_{\alpha\beta} +
  (1-w_\alpha w_\beta)\vect F^{\CG}_{\alpha\beta} +
  w_\alpha w_\beta (1-w_\alpha w_\beta)\vect F_{\alpha\beta}^{\rdf}.
\label{grf}
\end{align}
Where $ \vect F^{\AT}_{\alpha\beta}$, $ \vect F^{\CG}_{\alpha\beta}$
are the intermolecular interaction of the atomistic and coarse-grained
resolutions, respectively.  $\vect F_{\alpha\beta}^{\rdf}$ is a force that corrects the center of mass-center of mass radial distribution function (RDF) in the transition region $\Delta$ ~\cite{rdfcorr}. A further, one body force, named thermodynamic force, ${\vect F}^{\textrm{th}}$, is applied to ensure the correct thermodynamic equilibrium of the system:
\begin{equation}
  {\vect F}_{\alpha}=
  \sum_{\beta}{\vect F}_{\alpha\beta}+
  {\vect F}^{\textrm{th}}(\vect r_\alpha).
\label{mody}
\end{equation}
which is defined by
\begin{equation}
  p_{\AT}+
  \frac{\rho_{0}}{M_\alpha}
  \int_{\Delta} {\vect F}^\text{th}(\vect r)\,\dd d\vect r
  =p_{\CG}
  \label{thf}
\end{equation}
where $p_{\AT}$ is the pressure of the atomistic resolution, $p_{\CG}$ that of the coarse-grained resolution, $\rho_{0}$ is the equilibrium density, corresponding to that of a full atomistic simulation, and $M_{\alpha}$ is the mass of a molecule labeled with the index $\alpha$. For specific details, see Ref.~\cite{prlgc}. It must be noticed that the 
AdResS scheme is not Hamiltonian~\cite{presolo,prlcomm}. However, under the hypothesis of instantaneously
freezing the DOFs in the hybrid region, the atomistic and
coarse-grained regions can be considered Hamiltonian; this line of thought give rise to the basic
idea of the present study.

\section{Theoretical considerations}
\subsection{The outline of the basic idea}
Here we denote the degrees of freedoms and number of particles in the
atomistic region (AT), hybrid region ($\HY$) and the coarse-grained
region (CG) by $(\vect x_1, N_1)$, $(\vect x_2, N_2)$ and $(\vect x_3,
N_3)$, respectively. Therefore, the target is to prove that the atomistic
region is subject to the Grand Canonical ensemble: 
\begin{align}
  p(\vect x_1, N_1) = \frac{1}{\mathcal Q_1}
  e^{\beta\mu_{\AT} N_1 - \beta \mathcal H_{N_1}^{\AT}(\vect x_1)} 
\end{align}
where the partition function $\mathcal Q_1$ is defined by
\begin{align}
  \mathcal Q_1 =
  \sum_{N_1}\int
  \dd d\vect x\,
  e^{\beta\mu_{\AT} N_1 - \beta \mathcal H_{N_1}^{\AT}(\vect x_1)}
\end{align}
The marginal probability of finding $N_1$ molecules in the
AT region is:
\begin{align}\label{eqn:p-2}
  p(N_1) = \int\dd d\vect x_1\, p(\vect x_1, N_1)
  =
  \frac{1}{\mathcal Q_1}e^{\beta\mu_{AT} N_1}Q_{N_1}
\end{align}
where $Q_{N_1}$ is the partition function for a canonical ensemble
with $N_1$ atomistic molecules:
\begin{align}
  Q_{N_1}  =
  \int\dd d\vect x_1\,
  e^{ - \beta \mathcal H_{N_1}^{\AT}(\vect x_1)}
\end{align}
Let us consider:
\begin{align}
  p(\vect x_1, N_1) = p(\vect x_1 | N_1)\,p(N_1)
\end{align}
Rigorously speaking, for a truly Grand Canonical ensemble,
the conditional probability $p(\vect x_1 | N_1)$ 
should be
\begin{align}\label{eqn:p-1}
  p(\vect x_1 | N_1) &= \frac{1}{Q_{N_1}} e^{-\beta \mathcal H_{N_1}^{AT}(\vect x_1)} \end{align}
It must be kept in mind that we always compare the distributions of the AdResS simulation
with those of a full atomistic reference system, which is ideally divided
in subregions corresponding to the AT, $\HY$ and CG regions of the AdResS
set up. The first step in our procedure is to fix the number of molecules in the atomistic
region and consider the conditional probability $p(\vect x_1 |
N_1)$. If the AdResS set up, leads to the Grand Canonical ensemble, this
probability should be the same as the corresponding one of a full
atomistic reference system, namely Eqn.~\eqref{eqn:p-1}.  Then, if the
probability of finding $N_1$ molecules in the atomistic region is also
the same as the full atomistic reference system, namely
Eqn.~\eqref{eqn:p-2}, we can safely state that the atomistic region of AdResS
samples configurations in a Grand Canonical fashion. In fact, it must be noticed that a subsystem of full atomistic system is a natural Grand Canonical ensemble in the thermodynamic limit. 


\subsection{The probability $p(\vect x_1 | N_1)$}
To prove the statement above, the probability $p(\vect x_1 | N_1)$ is divided into two parts:
\begin{align}\label{eqn:divide-cond-p}
  p(\vect x_1 | N_1) = \sum_{N_2}\int
  p(\vect x_1 | N_1; \vect x_2, N_2) \,
  p(\vect x_2, N_2 | N_1)
  \,\dd d\vect x_2
\end{align}
$p(\vect x_1 | N_1; \vect x_2, N_2)$ is the probability obtained by fixing the
coordinates and number of particles in the region $\HY$ and considering
the distribution of the DOFs in the AT region. As we have shown before,
if we modify the weighting function by Eqn.~\eqref{eqn:new-w}
We can prove:
\begin{align}
  p(\vect x_1 | N_1; \vect x_2, N_2)
  \propto &\,
  e^{-\beta\mathcal H_{N_1}^{\AT}(\vect x_1; \vect x_2, N_2)}
\end{align}
with an atomistic Hamiltonian:
\begin{align}
  \mathcal H_{N_1}^{{\AT}}(\vect x_1; \vect x_2, N_2) = &\,
  \sum_{j=1}^{N_1}\frac12 m_i\vect v_i^2 + 
  \sum_{i,j=1}^{N_1}\frac12 U^{{\AT}}(\vect r_i - \vect r_j)  +
  \sum_{i=1}^{N_1}\sum_{j=N_1+1}^{N_2} U^{{\AT}}(\vect r_i - \vect r_j)   
\end{align}
which is exactly the same as the full atomistic reference system.
Here are some remarks on this argument:
\begin{enumerate}\itemsep -1pt
\item All interactions in the system are short-range with given cut-offs (the
  electrostatic interaction is treated by the reaction field method),
  so that the AT region does NOT interact in a direct way with the CG region.
\item The number of molecules and their coordinates are assumed to be
  fixed in the $\HY$ region.  Under this assumption, we firstly study
  the conditional probability $p(\vect x_1 | N_1; \vect x_2, N_2)$ of
  the AT region embedded in the fixed $\HY$ environment, and then count
  all possible realizations of configurations in the $\HY$ region, which is subject to
  the distribution $p(\vect x_2, N_2 | N_1)$.
  Eqn.~\eqref{eqn:divide-cond-p} validates this two-stage approach of
  investigating $p(\vect x_1 | N_1)$.
\item Due to the point 2, correlations between the molecules
  in $\HY$ and CG regions are not relevant in our argument, in fact
  the DOFs in the $\HY$ region are anyway considered instantaneously fixed while sampling configurations in the AT and CG regions.
\end{enumerate}

\noindent
At this point, the key question is whether the probability in the $\HY$ region, $p(\vect
x_2, N_2 | N_1)$ is the same as that of the equivalent region in a full atomistic reference
system. In general this seems not be the case, but it is possible to
derive necessary conditions to enforce such an equivalence; the simplest ones involve
the marginal distribution functions, namely:
\begin{align}
  \rho_{\HY}(\vect r) &= \rho_{\AT}(\vect r)\\
  g_{\HY}( r) &= g_{\AT}(r)
\end{align}
The first order marginal distribution is the particle (or molecular) density 
$\rho_{\HY}(\vect r)$, while the second order marginal distribution is
the radial distribution function (RDF), $g_{\HY}(r)$. The necessary
conditions are that these two distribution should be the same as those of the fully atomistic reference system.


\subsection{Statistical Mechanics meaning of the thermodynamic force within the Grand canonical framework}
One of the key point of the AdResS method is the introduction of the thermodynamic force, ${\bf F}_{th}$, to assure thermodynamic equilibrium to the system.
Thermodynamical considerations/intuitions, led to formula \ref{thf}. In this section we derive the physical and statistical meaning of such a force.
\begin{figure}
  \centering
  \begin{minipage}[t]{0.49\linewidth}
  \includegraphics[width=0.6\textwidth]{fig.grand/partition.eps}    
  \end{minipage}
  % \begin{minipage}[t]{0.49\linewidth}
  % \includegraphics[width=0.6\textwidth]{fig.grand/partition-1.eps}    
  % \end{minipage}
  \caption{Schematic plot of the AdResS system in thermodynamic equilibrium. The thickness of the filter corresponds to $d_{\Delta}$.}
  \label{fig:tmp1}
\end{figure}
Here, two assumptions are made:
\begin{enumerate}\itemsep -1pt
\item $N_2\ {\ll}\ N_1 \ll N_3$: the second inequality corresponds to
  the thermodynamic limit of the Grand Canonical ensemble. The first
  one actually assumes that the $\HY$ region is infinitely thin so that it
  can be viewed as an infinitesimal membrane that allows free exchange of molecules from
  the AT region to the CG region and vice versa.
\item We now define a supplementary Hamiltonian:
  \begin{equation}
    \mathcal H(\vect x_1, N_1; \vect x_3, N_3) =
    \mathcal H_{N_1}^{\AT}(\vect x_1) + \mathcal H_{N_3}^{\CG}(\vect x_3); 
  \end{equation}
  The condition above is true, in the thermodynamic limit, if the system is
  short-range correlated.
\end{enumerate}
The equilibrium in the AT and CG region is assured by the membrane $\HY$ via the thermodynamic force. Conceptually, we assume there is an infinitely thin
``filter'' (see Fig.~\ref{fig:tmp1}) located at the interface between
the AT and CG regions. When a molecule travels from the CG region to
the AT region, the filter does some work $\omega_0$ on the system.
Therefore, we add an empirical term in the Hamiltonian of the system
$N_1\omega_0$, which denotes the work done by the thermodynamic force.
% \recheck{
%   Actually, here, it is better to argue in this way:
%   $w_0$ can be the work of any force, not necessarily thermodynamics force,
%   because here we do not put any special condition on $w_0$.
%   It is simply ``the work done by the filter'' and can be any value.
%   It is important to notice
%   an arbitrary $w_0$ can also ensure an equilibrium between
%   the AT and CG region, but this equilibrium is generally
%   wrong, i.e. $\rho_{\AT}\neq \rho_{\CG} \neq \rho_0$.
%   But anyway we can prove the under this equilibrium (which may be
%   wrong), the chemical potential difference between the AT and
%   CG regions is the work $w_0$.
% }
Having fixed the number of molecules in the three regions, and by following the
arguments of the last section, both the AT and the CG regions are
subject to the Boltzmann distribution.
Thus, the fixed-number partition function of the system reads
\begin{align}\nonumber
  q(N,V,T)
  &= \frac1{N!}\int
  \dd d\vect x
  e^{-\beta
    [\mathcal H(\vect x_1, N_1; \vect x_3, N_3) +
    N_1\omega_0]}\\\nonumber
  &= \frac1{N!}\int
  \dd d\vect x_1\dd d\vect x_3\,
  e^{-\beta
    [\mathcal H_{N_1}^{\AT}(\vect x_1) +
    \mathcal H_{N_3}^{\CG}(\vect x_3) +
    N_1\omega_0]}\\\nonumber
  & = \frac{N_1!N_3!}{N!}
  e^{-\beta N_1\omega_0}
  \frac{1}{N_1!}\int\dd d\vect x_1 e^{-\beta\mathcal H_{N_1}^{\AT}(\vect x_1)}
  \frac{1}{N_3!}\int\dd d\vect x_3 e^{-\beta\mathcal H_{N_3}^{\CG}(\vect x_3)}\\
  & = \frac{N_1!N_3!}{N!}
  e^{-\beta N_1\omega_0}
  Q_{\AT}(N_1, V_1, T)\,
  Q_{\CG}(N_3, V_3, T) 
\end{align}
Considering the permutations of particles, the number of possibilities of
$N_1$ molecules being in the atomistic region and $N_3$ molecules being
in the coarse-grained region is  $\frac{N!}{N_1!N_3!}$.
Therefore, the partition function of the whole system reads
\begin{align}\nonumber
  Q(N,V,T) &= \sum_{N_1=1}^N
  \frac{N!}{N_1!N_3!} \frac{N_1!N_3!}{N!}
  e^{-\beta N_1\omega_0}
  Q_{\AT}(N_1, V_1, T)\,
  Q_{\CG}(N_3, V_3, T) \\
  &= \sum_{N_1=1}^N
  e^{-\beta N_1\omega_0}
  Q_{\AT}(N_1, V_1, T)\,
  Q_{\CG}(N_3, V_3, T) 
\end{align}
with natural relations:
\begin{align}
  N &= N_1 + N_3\\
  V &= V_1 + V_3
\end{align}
% The following approach can be found in, for example,
% Ref.~\cite{tuckeman2010statistical}.
First, for convenience, we denote that
\begin{align}
  \tilde q_{N_1} = 
  e^{-\beta N_1\omega_0}
  Q_{\AT}(N_1, V_1, T)\,
  Q_{\CG}(N - N_1, V_3, T),
\end{align}
and $\bar N_1$ is the value of where $\tilde q_{N_1}$ reaches
maximum, namely $\tilde q_{\bar N_1} = \max \tilde q_{N_1}$.
Since $\tilde q_{N_1}$ is positive definite, a basic
observation is that
\begin{align}
  \tilde q_{\bar N_1}
  \leq
  \sum_{N_1=1}^N \tilde q_{N_1}
  \leq
  N \tilde q_{\bar N_1}. 
\end{align}
Due to the monotonicity of the logarithm, we have
\begin{align}
  \ln\tilde q_{\bar N_1}
  \leq
  \ln\sum_{N_1=1}^N \tilde q_{N_1}
  \leq
  \ln (N \tilde q_{\bar N_1})
  =
  \ln N + \ln\tilde q_{\bar N_1}.
\end{align}
If $\ln N \ll \ln \tilde q_{\bar N_1}$ (the validity will be discussed
later), then 
\begin{align}
  \ln\sum_{N_1=1}^N \tilde q_{N_1}
  \approx
  \ln\tilde q_{\bar N_1},
\end{align}
which is
% It can be proved that (see ) if
% \begin{align}\label{eqn:condition}
%   -\beta \bar N_1\omega_0 +
%   \ln Q_{\AT}(\bar N_1, V_1, T) + \ln Q_{\CG}(N - \bar N_1, V_3, T) \gg \ln N 
% \end{align}
% where
% \begin{align}
%   \bar N_1 = \underset{N_1}{\textrm{argmax}}\:
%   e^{-\beta N_1\omega_0}
%   Q_{\AT}(N_1, V_1, T) \,Q_{\CG}(N - N_1, V_3, T)
% \end{align}
\begin{align}
  \ln Q(N, V, T)
  \approx
  -\beta \bar N_1\omega_0 + 
  \ln Q_{\AT}(\bar N_1, V_1, T) + \ln Q_{\CG}(N - \bar N_1, V_3, T)
\end{align}
or equivalently
\begin{align}\label{eqn:a-energy-1}
  A(N, V, T)
  \approx
  \bar N_1\omega_0 +
  A_{\AT}(\bar N_1, V_1, T) + A_{\CG}(N - \bar N_1, V_3, T)
\end{align}
Where $A$ denotes the Helmholtz free energy. 
The crucial question is if the condition $\ln N \ll \ln \tilde q_{\bar N_1}$
holds, or equivalently
\begin{align}\label{eqn:condition}
  \ln N 
  \ll
  -\beta \bar N_1\omega_0 +
  \ln Q_{\AT}(\bar N_1, V_1, T) + \ln Q_{\CG}(N - \bar N_1, V_3, T)
\end{align}
Generally this is true: $\log Q_{\CG}(N - \bar N_1, V_3, T)$
is proportional to the free energy $A_{\CG}(N - \bar N_1, V_3, T)$,
which is an extensive thermodynamic variable, so
$A_{\CG}(N - \bar N_1, V_3, T)$ is proportional to $N-\bar N_1$.
Due to the thermodynamic limit $N \gg \bar N_1$,
$A_{\CG}(N - \bar N_1, V_3, T)$ is actually proportional $N$, which
is much larger than $\ln N$ under thermodynamic limit. This
validates condition~\eqref{eqn:condition}.
We will see later (from Eqn.~\eqref{eqn:pn1})
that the maximum $\bar N_1$ corresponds to the maximum
value of probability $p(N_1)$; this is also the average molecule
number in the AT region that be of statistical importance
under the thermodynamic limit.  Since $\bar
N_1$ is the maximum, by differentiating on the right hand side of
Eqn.~\eqref{eqn:a-energy-1}, we have the relation:
\begin{align}
  \omega_0 = \mu_{\CG}(N - \bar N_1, V_3, T)  - \mu_{\AT}(\bar N_1, V_1, T)
\end{align}
That means that the difference in the chemical potential between the AT and CG
regions is taken care by the thermodynamic force.
If the thermodynamic force ensures an
equilibrium that is the same as the full atomistic reference system,
the work should be the same as the
chemical potential difference between the atomistic and coarse-grained
resolutions, namely
\begin{align}\label{eqn:w-mu-diff}
  \omega_0 = \mu_{\CG}(\rho_0V_3, V_3, T) - \mu_{AT}(\rho_0 V_1, V_1, T)
\end{align}
$\rho_0$ is the density at which the atomistic and coarse-grained
resolutions should match,
namely $\bar N_1 = \rho_0V_1$ and $N - \bar N_1 = \rho_0(V - V_1)$ should apply.
% \recheck{As we mentioned before, the work done by the filter
%   can be arbitrary, and may lead to a wrong equilibrium.
%   To ensure a right equilibrium, the necessary condition for
%   ``the work done by the filter'' is that it is the same
%   as the chemical potential difference between the
%   atomistic and coarse-grained resolutions. (Notice, the
%   conception is different from ``the chemical potential difference between
%   the AT and CG regions''. We should keep in mind this
%   difference to understand the argument correctly.
% }
Eqn.~\eqref{eqn:w-mu-diff} is a necessary
condition for the thermodynamic force that ensures
the correct equilibrium of the AT and CG regions.\\

\noindent
Now we translate from the language of Helmholtz free
energy into that of the grand potential.
Under the thermodynamic limit, they are the same.
Assuming the system reaches an
equilibrium of flat density profile of $\rho_0$ all over the AdResS simulation box, 
Eqn.~\eqref{eqn:a-energy-1} becomes:
\begin{align}\label{eqn:g-energy-1}
  G(\mu, V, T) \approx
  \rho_0V_1\omega_0
  + G_{\AT}(\mu_{\AT}, V_1, T) + G_{\CG}(\mu_{\CG}, V - V_1, T)
\end{align}
where
\begin{align}
  G(\mu, V, T) = A(N, V, T) - \mu_{\AT} \bar N_1 - \mu_{\CG}(N - \bar N_1)
\end{align}
Because of the equilibrium situation, the derivative of r.h.s. of
Eqn.~\eqref{eqn:g-energy-1} with respect to atomistic volume $V_1$
should vanishes (the same argument as the Helmholtz free energy):
\begin{align}
  \rho_0\omega_0 = -p_{\AT}+p_{\CG} \quad\Longrightarrow\quad
  p_{\AT} + \rho_0\omega_0 = p_{\CG}
\end{align}
which is exactly the definition of the thermodynamic force.
This is another necessary condition for the
thermodynamic force, which is actually satisfied by the definition of it,
namely Eqn.~\eqref{thf}.
The argument in this section is based on the fact that $\bar N_{1}$, rather than $N_{1}$ can be considered as representative of the configuration realizations in the AT region. This implies that the particle fluctuations, $\Delta N_{1}$,
are negligible (compared to $\bar N_{1}$) in the AT region. This hypothesis is valid if the AT region is large enough so that $\bar N_{1}$ is large. This point seems to be true in all numerical experiments done so far (see e.g. Ref.\cite{debash}).

\subsection{The number probability $p(N_1)$}
In this section, finally, we define at which level of approximation $p(N_{1})$, in AdResS is the same as in a full atomistic simulation.
Let us consider the marginal distribution $p(N_1)$
\begin{align}\nonumber
  p(N_1)
  % &=
  % \int
  % \dd d\vect x
  % \,e^{-\beta
  %   [\mathcal H(\vect x_1, N_1; \vect x_3, N_3) +
  %   N_1\omega_0]}\\\nonumber
  &=
  \frac{N!}{N_1!N_3!}
  \int
  \dd d\vect x_1\dd d\vect x_3  \:
  \frac{1}{Q(N,V,T) N!}
  e^{-\beta
    [\mathcal H_{N_1}^{\AT}(\vect x_1) +
    \mathcal H_{N_3}^{\CG}(\vect x_3) +
    N_1\omega_0]}\\\nonumber
  &=
  \frac{N!}{N_1!N_3!}
  \frac{N_1!N_3!}{Q(N,V,T) N!}
  e^{-\beta N_1\omega_0}
  \bigg[
  \frac1{N_1!}
  \int
  \dd d\vect x_1
  e^{-\beta \mathcal H_{N_1}^{\AT}(\vect x_1)}
  \bigg]
  \bigg[
  \frac1{N_3!}
  \int
  \dd d\vect x_3
  e^{-\beta \mathcal H_{N_3}^{\CG}(\vect x_3)}
  \bigg]  \\\label{eqn:pn1}
  &=
  \frac
  {
    e^{-\beta N_1\omega_0}
    Q_{\AT}(N_1,V_1,T) Q_{\CG}(N-N_1,V_3,T)
  }
  {
    \sum_{n_1}
    e^{-\beta n_1\omega_0}
    Q_{\AT}(n_1,V_1,T) Q_{\CG}(N-n_1,V_3,T)
  }
\end{align}
where $n_1$ is the summation variable that goes from 0 to $N$,
however, when $n_1$ is not much smaller than $N$ (i.e. out of the range of the
thermodynamic limit), the statistic is only of marginal importance,
and can be neglected safely.
The atomistic marginal distribution, which the AdResS simulation should
reproduce is
\begin{align}
  p_{\AT}(N_1)
  &=
  \frac
  {
    Q_{\AT}(N_1,V_1,T) Q_{\AT}(N-N_1,V_3,T)
  }
  {
    \sum_{n_1}
    Q_{\AT}(n_1,V_1,T) Q_{\AT}(N-n_1,V_3,T)
  }  
\end{align}
We want to calculate the difference between $p(N_1)$ and $p_{\AT}(N_1)$.
By multiplying the numerator of $p(N_1)$ by the denominator of
$p_{\AT}(N_1)$ (denoted by $T_1$),
and multiplying the numerator of $p_{\AT}(N_1)$
by the denominator of $p(N_1)$ (denoted by $T_2$), we have
\begin{align}
  T_1
  &=
  e^{-\beta N_1\omega_0}
  Q_{\AT}(N_1,V_1,T) Q_{\CG}(N-N_1,V_3,T)
  \times
  \sum_{n_1}
  Q_{\AT}(n_1,V_1,T) Q_{\AT}(N-n_1,V_3,T)\\
  T_2
  &=
  Q_{\AT}(N_1,V_1,T) Q_{\AT}(N-N_1,V_3,T)
  \times
  \sum_{n_1}
  e^{-\beta n_1\omega_0}
  Q_{\AT}(n_1,V_1,T) Q_{\CG}(N-n_1,V_3,T)
\end{align}
The difference between $T_1$ and $T_2$ is basically the difference
between $p(N_1)$ and $p_{\AT}(N_1)$.
Calculating $T_1$:
\begin{align}\nonumber
  T_1
  &=
  \sum_{n_1}
  e^{-\beta N_1\omega_0}
  Q_{\AT}(n_1,V_1,T)\,
  Q_{\AT}(N_1,V_1,T)\,
  Q_{\AT}(N-n_1,V_3,T)\,
  Q_{\CG}(N-N_1,V_3,T) \\\label{eqn:t1-1}
  &=
  \sum_{n_1}
  \exp
  \big\{-\beta
  \big[
  \omega_0N_1 +
  A_{\AT}(n_1,V_1,T) +
  A_{\AT}(N_1,V_1,T) +
  A_{\AT}(N-n_1,V_3,T) +
  A_{\CG}(N-N_1,V_3,T)
  \big]
  \big\}
\end{align}
Since we work under the hypothesis that the atomistic region is much smaller than the whole system, it
is reasonable to assume $n_1 \ll N$ and $N_1\ll N$.
Notice the free energy is extensive.
Due to the Euler's theorem~\cite{tuckeman2010statistical},
we have
\begin{align}\label{eqn:Aat-0}
  A_{\AT}(N-n_1,V_3,T)
  &= V_3 A_{\AT}(\frac{N-n_1}{V_3},1,T)
  = V_3 A_{\AT}(\rho_0 + \frac{\hat N_1 - n_1}{V_3},1,T)\\\label{eqn:Acg-0}
  A_{\CG}(N-N_1,V_3,T)
  &= V_3 A_{\CG}(\frac{N-N_1}{V_3},1,T)
  = V_3 A_{\CG}(\rho_0 + \frac{\hat N_1 - N_1}{V_3},1,T),
\end{align}
where $\hat N_1$ is the number of molecules in the atomistic region
if the density there is the correct density $\rho_0$, namely
$\hat N_1 = \rho_0V_1 = N - \rho_0 V_3$.
Notice, under the thermodynamic limit, $\hat N_1$ is equivalent to
$\bar N_1$.
$A_{\AT}(\rho_0 + (\hat N_1 - n_1)/{V_3},1,T)$ and
$A_{\CG}(\rho_0 + (\hat N_1 - N_1)/{V_3},1,T)$ are
the free energies in the \emph{unit} volume, with
the density perturbed from $\rho_0$ by  $(\hat N_1 - n_1)/{V_3}$
and $(\hat N_1 - N_1)/{V_3}$, respectively.
Actually, these perturbations originate from the fluctuating
number of molecules in the atomistic region: when the number
deviates from $\hat N_1$, some molecules enter the coarse-grained
region, and the density is perturbed.
Under the thermodynamic
limit, $\hat N_1$ is comparable to $n_1$ and $N_1$, and all of them are
much smaller than $N$. $V_3$ is comparable to $V$.
Since $\rho_0 = N/V$ always holds, the perturbations
$(\hat N_1 - n_1)/{V_3}$
and $(\hat N_1 - N_1)/{V_3}$ are small.
Therefore, we have the following
Taylor expansions of the free energies \eqref{eqn:Aat-0} and \eqref{eqn:Acg-0}
about $\rho_0$:
\begin{align}
  A_{\AT}(\rho_0 + \frac{\hat N_1 - n_1}{V_3},1,T)
  &= A_{\AT}(\rho_0,1,T)
  +\mu_{\AT}
  \Big(
  \frac{\hat N_1 - n_1}{V_3}
  \Big)
  +
  \frac1{2\rho_0^2\,\kappa_{\AT}}
  \Big(
  \frac{\hat N_1 - n_1}{V_3}
  \Big)^2
  + \textrm{h.o.t.} \\
  A_{\CG}(\rho_0 + \frac{\hat N_1 - N_1}{V_3},1,T)
  &= A_{\CG}(\rho_0,1,T)
  +\mu_{\CG}
  \Big(
  \frac{\hat N_1 - N_1}{V_3}
  \Big)
  +
  \frac1{2\rho_0^2\,\kappa_{\CG}}
  \Big(
  \frac{\hat N_1 - N_1}{V_3}
  \Big)^2
  + \textrm{h.o.t.} 
  % A_{\AT}(N-n_1,V_3,T)
  % &=
  % A_{\AT}(N,V_3,T)
  % - \mu_{\AT}\,n_1
  % + \frac12 \kappa_{\AT}\,n_1^2 + \textrm{h.o.t.} \\
  % A_{\CG}(N-N_1,V_3,T)
  % &=
  % A_{\CG}(N,V_3,T)
  % - \mu_{\CG}\,N_1
  % + \frac12 \kappa_{\CG}\,N_1^2 + \textrm{h.o.t.}
\end{align}
% The free energy
% $A_{\AT}(N-n_1,V_3,T)$ and $A_{\CG}(N-N_1,V_3,T)$
% are expanded with respect to $A_{\AT}(N,V_3,T)$ and $A_{\CG}(N,V_3,T)$,
% respectively. They are the free energies of 
% systems with number of particles $N$ in the volume $V_3$. Due to the
% thermodynamic limit $N\approx N-n_1$ and $N\approx N-N_1$, these
% free energies are not small, and the expansions are physically meanful.
The ``h.o.t.'' stands for higher order terms (greater than 2)
of the density perturbation, which we neglect since they have been found numerically not relevant.
% Notice that in Eqn.~\eqref{eqn:t1-1}, the negative value
% of the free energy are exponented, so the h.o.t  actually
% converge faster than the 1st and 2nd order terms.
By using the conditions:
\begin{align}\label{eqn:mu-eq}
  \mu_{\CG} &= \mu_{\AT} + \omega_0\\\label{eqn:kappa-eq}
  \kappa_{\CG} &= \kappa_{\AT}
\end{align}
We have $T_1$
\begin{align}\nonumber
  T_1
  = \,&
  \sum_{n_1}
  \exp
  \Big\{-\beta
  \Big[
  A_{\AT}(n_1,V_1,T) +
  A_{\AT}(N_1,V_1,T) +
  A_{\AT}(\rho_0V_3,V_3,T) +
  A_{\CG}(\rho_0V_3,V_3,T) \\
  \,&+(\mu_\AT + \mu_\CG)\hat N_1
  -\mu_{\AT}\,(N_1 + n_1) +
  \frac{V_3}{2\rho_0\, \kappa_{\AT}}
  \Big[
  \Big(
  \frac{\hat N_1 - n_1}{V_3}
  \Big)^2
  +
  \Big(
  \frac{\hat N_1 - N_1}{V_3}
  \Big)^2
  \Big]
  +\textrm{h.o.t.}
  \Big]
  \Big\}
\end{align}
% Similarly, multiplying the numerator of $p_{\AT}(N_1)$ by the denominator of
% $p(N_1)$, we have the term denoted by $T_2$
Similarly, we calculate $T_2$:
\begin{align}\nonumber
  T_2
  &=
  \sum_{n_1}
  e^{-\beta n_1\omega_0}
  Q_{\AT}(n_1,V_1,T)\,
  Q_{\AT}(N_1,V_1,T)\,
  Q_{\CG}(N-n_1,V_3,T)\,
  Q_{\AT}(N-N_1,V_3,T) \\\nonumber
  &=
  \sum_{n_1}
  \exp
  \big\{-\beta
  \big[
  \omega_0n_1 +
  A_{\AT}(n_1,V_1,T) +
  A_{\AT}(N_1,V_1,T) +
  A_{\CG}(N-n_1,V_3,T) +
  A_{\AT}(N-N_1,V_3,T)
  \big]
  \big\}
\end{align}
with similar expansions and by the conditions Eqn.~\eqref{eqn:mu-eq}
and \eqref{eqn:kappa-eq}, we have:
\begin{align}\nonumber
  T_2
  = \,&
  \sum_{n_1}
  \exp
  \Big\{-\beta
  \Big[
  A_{\AT}(n_1,V_1,T) +
  A_{\AT}(N_1,V_1,T) +
  A_{\AT}(\rho_0V_3,V_3,T) +
  A_{\CG}(\rho_0V_3,V_3,T) \\
  \,&+(\mu_\AT + \mu_\CG)\hat N_1
  -\mu_{\AT}\,(N_1 + n_1) +
  \frac{V_3}{2\rho_0\, \kappa_{\AT}}
  \Big[
  \Big(
  \frac{\hat N_1 - n_1}{V_3}
  \Big)^2
  +
  \Big(
  \frac{\hat N_1 - N_1}{V_3}
  \Big)^2
  \Big]
  +\textrm{h.o.t.}
  \Big]
  \Big\}
\end{align}
% \begin{align}\nonumber
%   T_2
%   = \,&
%   \sum_{n_1}
%   \exp
%   \big\{-\beta
%   \big[
%   A_{\AT}(n_1,V_1,T) +
%   A_{\AT}(N_1,V_1,T) +
%   A_{\AT}(N,V_3,T) +
%   A_{\CG}(N,V_3,T) \\
%   \,&-
%   \mu_{\AT}\,(N_1 + n_1) +
%   \frac12 \kappa_{\AT}(N_1^2 + n_1^2) +
%    \textrm{h.o.t.}
%   \big]
%   \big\}
% \end{align}
Therefore, term $T_1$ and $T_2$ are equivalent (at least) to the second leading
order with respect to the density perturbations
$(\hat N_1 - n_1)/{V_3}$
and $(\hat N_1 - N_1)/{V_3}$.
Since the difference between the probabilities
$p(N_1)$ and $p_{\AT}(N_1)$ is basically the difference between $T_1$
and $T_2$, we conclude that $p(N_1)$ is a good approximation to
$p_{\AT}(N_1)$ to the second leading order. High orders, as anticipated before, seem numerically not relevant and anyway, at this stage, not easy to treat at formal level.
\section{Conclusions}
We have shown a detailed theoretical analysis about the validity and meaning of the AdResS method within the framework of a Grand Canonical ensemble. We have interpreted the thermodynamic force as a tool to balance the difference in chemical potential due to the different resolutions in space and have shown that $p(N_{1})$, the probability distribution in the atomistic region of AdResS is equivalent to that in the same region in a full atomistic simulation, up to a second order expansion. These results provide a solid theoretical basis to explain the numerical reliability of the AdResS method and its interpretation as an effective Grand Canonical set up.


\section*{References}
\bibliography{ref}{}
\bibliographystyle{unsrt}





\end{document}