\documentclass[aps,pre,preprint,unsortedaddress]{revtex4}
% \documentclass[aps,pre,twocolumn]{revtex4-1}
% \documentclass[aps,jcp,groupedaddress,twocolumn,unsortedaddress]{revtex4}

\usepackage{amsmath}
\usepackage{amssymb}
\usepackage[dvips]{graphicx}
\usepackage{color}
\usepackage{tabularx}
\usepackage{algorithm}
\usepackage{algorithmic}



\newcommand{\recheck}[1]{{\color{red} #1}}
\newcommand{\redc}[1]{{\color{red} #1}}
\newcommand{\bluec}[1]{{\color{blue} #1}}
\renewcommand{\v}[1]{\textbf{\textit{#1}}}
\renewcommand{\d}[1]{\textsf{#1}}


\begin{document}

\title{Onsager regression method via Adaptive Resolution Simulation}


\begin{abstract}
We combine the Onsager regression method with the adaptive resolution simulation scheme.
\end{abstract}

\maketitle

\section{Theoretical Principles}
Let us suppose we have a system which is in equilibrium with a reservoir of energy and particles (i.e. Grand Canonical ensemble), at a certain time we apply a perturbation to the system. Such a perturbation will induce a response from the system. Let us identify $\hat{O}({\bf r,p})$ as the physical observable which expresses the response to the perturbation. If the system was characterized by a constant number of particle $\hat{N}$, then the average response of the system at time $t$ would be expressed by the equation:
\begin{equation}
O(t)=\int d{\bf r}d{\bf p} \hat{O}({\bf r,p})\rho_{\hat{N}}({\bf r,p};t)
\label{o1}
\end{equation}
or equivalently:
\begin{equation}
\int d{\bf r}d{\bf p} \hat{O}({\bf r,p})\rho_{\hat{N}}({\bf r,p};t)=\int d{\bf r}d{\bf p} \hat{O}({\bf r}(t),{\bf p}(t))\rho_{\hat{N}}({\bf r,p};0)
\label{o2}
\end{equation}
with:
\begin{equation}
\rho_{\hat{N}}({\bf r,p};0)=\rho_{\hat{N}}({\bf r,p}) lim_{T \to\infty}\frac{1}{T}\int_{0}^{T} d\tau \hat{O}\left({\bf r}(t; {\bf r}_{0}(\tau), {\bf p}_{0}(\tau)),{\bf p}(t;{\bf r}_{0}(\tau), {\bf p}_{0}(\tau)\right)
\label{rhon}
\end{equation} 
with $\rho_{\hat{N}}({\bf r,p})$ the standard canonical distribution at fixed $\hat{N}$. However in the present case, already before applying a perturbation we have a system whose total number of particles $N$ fluctuates, moreover when we apply the pertubation to such system the average response needs to be sampled over all possible realization (corresponding to each value of $N$), thus the formulas above are likely to be modified as:
\begin{equation}
O(t)=\left<\left<\hat{O}_{N}(t)|N\right>\right>_{N}=\sum_{N=0}^{\infty}P(N)\int d{\bf r}d{\bf p}\rho_{N}({\bf r,p})\hat{O}({\bf r}(t),{\bf p}(t))
\label{newvers}
\end{equation}
where:
\begin{equation}
P(N)=\frac{e^{\beta\mu N}Q_{N}}{Q}
\end{equation}
and
\begin{equation}
Q=\sum_{N}e^{\beta\mu N}Q_{N}
\end{equation}
with
\begin{equation}
Q_{N}=\int d{\bf r}d{\bf p} \frac{e^{-\beta H_{N}}}{N!h^{3N}}
\end{equation}
and
\begin{equation}
\rho_{N}({\bf r,p})=\frac{e^{-\beta H_{N}}}{N}.
\end{equation}
The essential meaning of Eq.\ref{newvers} is that we let the system evolve and calculate the average, counting the contribution of each $\hat{O}$ at each realization of $N$, weighted by the corresponding distribution for this realization $N$. So far this is the standard average in a Grand Canonical ensemble. The formulation above is nothing else than the extension of the Onsager-Kubo equation to the Grand Canonical case.
Let us discuss this in detail. Since our central quantities are $\rho_{N}$ , and in general all operators are of the form $X_{N}$ ($X$ generic operator), let us apply the procedure behind the Onsager-Kubo equation to quantities that are $N$ labeled, meaning that they depend on $N$. Liouville equation can then be written as:
\begin{equation}
\frac{\partial\rho_{N}}{\partial t}=i L_{N}\rho_{N}=iL_{N}^{0}\rho_{N}+iL_{N}^{P}\rho_{N}=\{H_{N}^{0},\rho_{N}\}+\{H^{P}_{N},\rho_{N}\}
\label{liouville}
\end{equation}
where $0$ and $p$ are indicating the unperturbed $L$ or $H$ operator and the perturbed one respectively.
For the distribution of the system we have:
\begin{equation}
\rho_{N}({\bf r},{\bf p},t)=S^{\dagger}_{N}(t)\rho_{N}({\bf r},{\bf p},0)
\end{equation}
An observable $\hat{O}$ of the system evolves as:
\begin{equation}
\hat{O}_{N}(t)=\hat{O}({\bf r}(t),{\bf p}(t),N)=S_{N}(t)\hat{O}(0)
\end{equation}
The non equilibrium average of a given observable, $N$-labeled, i.e. $N$-dependent is obtained via:
\begin{equation}
\frac{d \hat{J}_{N}}{dt}=iL_{N}\hat{J}_{N};\hat{J}_{N}(t)=S_{N}(t)\hat{J}_{N}
\end{equation}
this could be calculated via an "equilibrium average as (Onsager-Kubo equation):
\begin{equation}
\hat{J}_{N}(t)=<\hat{J}>_{N}
\end{equation}
that is
\begin{equation}
<\hat{J}>_{N}=\int d\Gamma_{N}\hat{J}_{N}\rho_{N}(t)=(\hat{J}_{N},S^{\dagger}_{N}(t)\rho_{N}^{0})
\end{equation}
where $\Gamma_{N}$ is the phase space of the system, and finally:
\begin{equation}
 (\hat{J}_{N},S^{\dagger}_{N}(t)\rho_{N}^{0})=(S_{N}(t)\hat{J}_{N}, \rho_{N}^{0}).
\end{equation}
Now its average over the realizations $N$ follows as:
\begin{equation}
\left<\left<\hat{J}(t|N)\right>\right>_{N}=\sum_{N}p(N)\hat{J}_{N}(t)=\sum_{N}\int d{\bf r}d{\bf p}\hat{J}_{N}(t)\rho_{N}({\bf r},{\bf p}, t=0)
\end{equation}
where it must be noticed that $\rho_{N}({\bf r},{\bf p}, t=0)$ is the $\rho_{equil}({\bf r},{\bf p})$.
This obvious extension is physically correct.
Let us see how to implement it. We have taken an initial condition with a given number of particles. Then, starting from this initial condition we allowed the system to freely evolve (with no constraints on $N$) and let the system go to the Grand Canonical equilibrium. Then we picked from time to time at regular intervals of time, initial conditions for the perturbed dynamics each with its $N$ kept fixed. After certain time we will have picked up a statistically significant realizations with different possible $N$ from the distribution $P(N)$.\\
The difference between the Grand Canonical approach and the Canonical approach is that:\\
(a)We need long non equilibrium trajectories to be sure that we sample enough segments with given $N$ along the non equilibrium trajectories\\
(b)A number of initial conditions with different $N$ large enough to be meaningful, that is, a dense branching along the Grand Canonical equilibrium trajectory.\\
In any case the advantage of this approach compared to an all atom simulation is the drastic reduction of computational cost of each simulation. 
\bibliography{ref}{}
\bibliographystyle{unsrt}

\end{document}
